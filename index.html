<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="css/jbnd.css">
    <link rel="stylesheet" type="text/html" href="js/x3dom.css"/>

    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/orbits.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/x3dom.js"></script>

    <script type="text/javascript" src="js/3d.js"></script>
    <script type="text/javascript" src="js/htmltable.js"></script>

    <script type="text/javascript" src="js/colors.js"></script>
    <script type="text/javascript" src="js/cycles-x3dom.js"></script>


    <script type="text/javascript" src="js/3d.js"></script>
    <script type="text/javascript" src="js/clockfaces.js"></script>
    <script type="text/javascript" src="js/orbitation.js"></script>
    <script type="text/javascript" src="js/forces.js"></script>


    <script>
        const pages = {
<!--            'page-0-1': '0.1-the-multiplicative-group.html',-->
            'page-1-0': '1.0-tally-ho.html',
<!--            'page-2-0': '2.0-place-value-tables.html',-->
<!--            'page-3-0': '3.0-conjugate-points-radiance.html',-->
<!--            'page-4-0': '4.0-two-dimensional-boxes.html',-->
<!--            'page-4-1': '4.1-two-more-boxes.html',-->
<!--            'page-5-0': '5.0-three-dimensional-boxes.html'-->
        };

        function includePages() {
            const pagesElement = document.getElementById( 'pages' );
            const tally = Object.keys( pages );

            const topScope = {
            };

            Object
                .entries( pages )
                .forEach( entry => {
                    const [ id, src ] = entry;

                    const entryElement = reify( "div", { id: id } );
                    pagesElement.appendChild( entryElement );

                    const request = new XMLHttpRequest();

                    const includer = () => {
                        try {
                            entryElement.innerHTML = request.responseText;

                            const scripts = [];
                            entryElement
                                .querySelectorAll( "script" )
                                .forEach( s => {
                                    scripts.push( s.textContent );
                                } );

                            // scripts do not run concurrently
                            const pageScope = {
                                id: id,
                                src: src
                            };

                            scripts
                                .filter( s => s.length > 0 )
                                .forEach( ( s, i ) => {
                                    try {
                                        const scriptLines = [
                                            '"use strict";',
                                            "const [ pageScope, topScope ] = arguments;",
                                            "try {", s, "} catch ( e ) {",
                                            `  const msg = "Script [${ src }#${ id }#${ i + 1 }]; " + e;`,
                                            "  console.log( msg );",
                                            "  console.trace();",
                                            "  throw new Error( msg, { cause: e } );",
                                            "}",
                                            ];

                                        Function( scriptLines.join( "\n" ) )( pageScope, topScope );
                                    } catch ( e ) {
                                        document
                                            .getElementById( "load-errors" )
                                            .appendChild( reify( "div", {}, [], [ c => c.innerHTML = e.toString() ] ) )
                                    }
                                } );

                            entryElement
                                .querySelectorAll( ".eval" )
                                .forEach( ( ref, i ) => {
                                    try {
                                        const t = eval( ref.title );
                                        if ( t ) {
                                            ref.innerHTML = t;
                                        } else {
                                            throw new Error( "Invalid Object: " + t );
                                        }
                                    } catch ( e ) {
                                        const msg = `Bad Eval Title [${ src }#${ id }#${ i + 1 }]: title=${ ref.title }; ${ e }`;
                                        console.log( msg );
                                        document
                                            .getElementById( "load-errors" )
                                            .appendChild( reify( "div", {}, [], [ c => c.innerHTML = msg ] ) )
                                    }
                                } );

                            entryElement
                                .querySelectorAll( ".evalNode" )
                                .forEach( ( ref, i ) => {
                                    try {
                                        const t = eval( ref.title );
                                        if ( t instanceof Element ) {
                                            ref.appendChild( t );
                                        } else {
                                            throw new Error( "Object reference not found: " + ref.title );
                                        }
                                    } catch ( e ) {
                                        const msg = `Bad Eval Node Title [${ src }#${ id }#${ i + 1 }]; title=${ ref.title }; ${ e }`;
                                        console.log( msg );
                                        document
                                            .getElementById( "load-errors" )
                                            .appendChild( reify( "div", {}, [], [ c => c.innerHTML = msg ] ) )
                                    }
                                } );

                        } catch ( e ) {
                            console.log( e );
                            console.trace();
                            document
                                .getElementById( "load-errors" )
                                .appendChild( reify( "div", {}, [], [ c => c.innerHTML = e.toString() ] ) )
                        } finally {
                            tally.pop();
                            if ( tally.length == 0 ) {
                                x3dom.reload();
                            }
                        }
                    };

                    request.addEventListener( "load", includer );
                    request.open( "GET", src );
                    request.send();
                } );
        }
    </script>
    <style>
        .multiplicative-group-table { font-size: 80%; border-top: solid 1px black; border-bottom: solid 1px black }
        .multiplicative-group-table th { vertical-align: top; background: WhiteSmoke; }
        .multiplicative-group-table tr { vertical-align: top; background: Ivory; }
        #.multiplicative-group-table tr:nth-child(even) { }
        #.multiplicative-group-table tr:nth-child(odd) { background: WhiteSmoke; }
        .multiplicative-group-table tr > td { border-top: 1px black dotted; padding-right: 5pt;}
        .multiplicative-group-table tr.box-side-length { background: rgb(175, 225, 175); }
        .multiplicative-group-table tr.inverse-box-side-length { background: rgb(173, 216, 230); }

         td.centre-label { text-align: center; }

         td.cell { border: 1px dotted blue; padding: 5px; margin: 10px; border-radius: 25%; text-align: center; font-size: 70%; }
         td.cell sub { font-size: 70%; }
         td.pack { border: 0px solid black; padding: 0px; margin: 0px; text-align: center; }
         tr.pack {}
         table.pack { border: 1px dotted black; padding: 0px; margin: 0px; border-spacing: 10px;  border-radius: 25%; width: 100%; }
         table.packing { border: 1px dotted black; padding: 15px; margin: 15px; border-radius: 25%; }
         table.packing caption { font-size: 80%; }


        .resizable {
            resize:both;
            overflow-wrap: normal;
            overflow-x: scroll;
            white-space: pre;
        }
        .leftFlow {
           float: left;
        }
        .rightFlow {
           float: right;
        }
        .noFlow {
           float: inline-start;
        }
        tr.selected td {
            background: pink;
        }

        .grid-of-cells {
            margin: 0px;
            padding: 0px;
            border: 0px;
        }

        #load-errors { color: red; font-weight: bold;}
        a.def, a.def:hover, a.def:focus, a.def:active { text-decoration: none; color: inherit; }
</style>
</head>
<body onload="includePages()">
    <div id="load-errors"></div>
    <h1>Thinking inside the Box</h1>
<!--    <div>-->
<!--        Alaric Dobson, 2022-03-07<br/>-->
<!--        alaric@brentcroft.com-->
<!--    </div>-->
    <div id="pages"></div>
</body>
</html>
