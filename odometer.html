<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>


    <link rel="stylesheet" href="css/pagery.css">
    <link rel="stylesheet" type="text/html" href="js/x3dom.css"/>

    <script type="text/javascript" src="js/reify.js"></script>

    <script type="text/javascript" src="js/x3dom.js"></script>
    <script type="text/javascript" src="js/3d.js"></script>
    <script type="text/javascript" src="js/colors.js"></script>
    <script type="text/javascript" src="js/cycles-x3dom.js"></script>

    <script type="text/javascript" src="js/nearley/moo.js"></script>
    <script type="text/javascript" src="js/nearley/grammar.js"></script>
    <script type="text/javascript" src="js/nearley/nearly.js"></script>


    <script type="text/javascript" src="js/factors.js"></script>

    <script type="text/javascript" src="js/odometer.js"></script>
    <script type="text/javascript" src="js/odometer-dom.js"></script>
    <script type="text/javascript" src="js/odometer-expression.js"></script>

    <script>
        function byId( id ) {
            return document.getElementById(id);
        }
        function getMonomialFilter() {
            if( byId( 'monomialFilterToggle' ).checked ) {
                return JSON.parse( byId( 'monomialFilter' ).value || null );
            }
            return null;
        }
        function drawActionsTables() {
            if ( byId('actionsTableToggle').checked ) {
                byId( 'boxActions' ).appendChild( reify( 'hr' ) );
                const actions = Box
                        .list()
                        .filter( box => box.actions().length > 0 )
                        .flatMap( box => box.actions() );
                byId( 'boxActions' )
                    .appendChild( reify(
                        'div',
                        { 'class': 'expressionScriptResult' },
                        [ cyclesDomNode( actions, 'Box Actions', getMonomialFilter(), byId( 'boxCycles' ) ) ]
                    ) );
            } else {
                byId( 'boxActions' ).innerHTML = '';
            }
        }
        function putHtml( actions, param ) {
            const container = byId( 'expressionResults' );
            if (!actions) {
                container.appendChild( reify( 'pre', { 'class': 'expressionScriptError' }, [ reifyText( 'No result!' ) ] ) );
            } else if ( actions[0] instanceof Cycles ) {
                container.appendChild( reify(
                    'div',
                    { 'class': 'expressionScriptResult' },
                    [ cyclesDomNode( actions, 'Expression Results', getMonomialFilter(), byId( 'boxCycles' ) ) ]
                ) );
                expressionResults
                    .querySelectorAll( 'tr.default-selection' )
                    .forEach( element => element.click() );

            } else {
                container.appendChild( reify( 'pre', { 'class': 'expressionScriptError' }, [ reifyText( actions ) ] ) );
            }
        }
        function clearResults() {
            expressionResults
                .querySelectorAll( '.expressionScriptError' )
                .forEach( element => element.parentNode.removeChild( element ) );
            expressionResults
                .querySelectorAll( '.expressionScriptResult' )
                .forEach( element => element.parentNode.removeChild( element ) );
            const boxActions = byId( 'boxActions' );
            if ( boxActions ) {
                boxActions.innerHTML = '';
            }
            Box.clear();
        }
        function calculate( script, sourceElement ) {
            const isFormula = byId( 'formulaToggle' ).checked;
            try {
                const cycles = isFormula
                    ? new Operation( script ).evaluate()
                    : eval( script );
                putHtml( cycles );
            } catch ( e ) {
                console.log( `Error processing script: ${ e }` );
                putHtml( e );
                throw e;
            }
        }
        function calculateNow() {
            if ( byId( 'clearOnCalculate' ).checked ) {
                clearResults();
            }
            calculate( byId( 'expressionScript' ).value );
            drawActionsTables();
            x3dom.reload();
        }
        function renderExpressionLinks( expressions ) {
            const expressionScript = byId('expressionScript');
            byId( 'expressionsLibrary' ).appendChild(
                reify('div',{}, Object
                        .entries( expressions )
                        .map( ([key, group], i) => reify( 'label', { 'class': 'columnSelector' }, [
                                reifyText( i > 0 ? ' | ' : 'expressions: ' ),
                                reify( 'a', {}, [ reifyText( key ) ], [
                                        c => c.onclick = (event) => {
                                                expressionScript.innerHTML = group.join('\n');
                                                calculateNow();
                                            }
                                    ] ),
                        ] ) ) ) );
        }
        const expressions = {
            'blank': [
            ],
            'unit-boxes': [
                '2:2',
                '3:2',
                '4:2',
                '3:3',
                '4:3',
                '7:2',
                '5:3',
                '4:4',
                '6:3',
                '5:4',
                '7:3',
                '11:2',
                '6:4',
                '5:5',
            ],
            'powers': [
                '(10:4)^-1',
                '(10:4)^0',
                '(10:4)^1',
                '(10:4)^2',
                '(10:4)^3',
                '(10:4)^4',
                '(10:4)^5',
                '(10:4)^6',
            ],
            '5x3x2': [
                '5:3~2; 2:5~3; 3:2~5',
                '2~5:3; 3~2:5; 5~3:2',
                '5:8; 3:10; 2:20;',
                '5:3:2; 2:5:3; 3:2:5',
                '(3~5:2) * (3:2~5) * (2~5:3)',
            ],
            '5x4x2': [
                '5:4~2; 2:5~4; 4:2~5',
                '2~5:4; 4~2:5; 5~4:2',
                '5:8; 4:10; 2:20;',
                '5:4:2; 2:5:4; 4:2:5',
                '(4~5:2) * (4:2~5) * (2~5:4)',
            ],
            '7x5x3': [
                '3:5~7; 7:3~5;  5:7~3',
                '(7:3~5)*(5:3~7)',
                '15:7; 21:5; 3:35'
            ],
            'rotations': [
                '(2:4)',
                '(2:4)~5',
                '(4:2)~5',
                '5~(4:2)',
                '5~(2:4)',
            ],
            'compounds': [
                '((4:2)~5)*(2~(5:4))',
                '(5~(4:2))*((5:4)~2)',

                '(4~(5:2))*((4:2)~5)*(2~(5:4))',
                '((4~(5:2))*((4:2)~5))*(2~(5:4))',
            ]
        };
    </script>
</head>
<body onload="renderExpressionLinks( expressions ); calculateNow()">
    | <label class="columnSelector">expressions:<input type="checkbox" checked="checked" id="expressionPanelToggle" onclick="showHide( 'expressionScriptLabel', this );"/></label>
    | <label class="columnSelector">boxes:<input type="checkbox" id="actionsTableToggle" onclick="showHide( 'boxActions', this );drawActionsTables()"/></label>
    <label  style="display: none" class="columnSelector">clear on calculate:<input type="checkbox" checked="checked" id="clearOnCalculate"/></label>
    | <label class="columnSelector">formula:<input type="checkbox" checked="checked" id="formulaToggle"/></label>
    | <label class="columnSelector">diagram:<input type="checkbox" id="cyclesDiagramToggle" onclick="calculateNow()"/></label>
    | <label class="columnSelector">filter:<input type="checkbox" id="monomialFilterToggle" onclick="calculateNow()"></label>
    <label class="columnSelector">
        <input type="hidden" id="monomialFilter">
        <span id="monomialFilterDisplay"></span>
    </label>

    <label for="expressionScript" id="expressionScriptLabel">
        <hr/>
        <span id="expressionsLibrary"></span>
        <textarea id="expressionScript" class="expression" oninput="calculateNow()">
5:4:2 # [0,1,2]
5:4:2 [1,2,0]
5:4:2 [2,0,1]
5:4:2 [2,1,0]
5:4:2 [1,0,2]
5:4:2 [2,0,1]</textarea>
    </label>

    <hr/>

    <div id="expressionResults"></div>

    <div id="boxActions" style="display: none"></div>
</body>
</html>