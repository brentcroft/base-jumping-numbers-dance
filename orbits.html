<html>
<head>
    <meta charset="utf-8"/>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 80%;
            padding-left: 20pt;
            padding-right: 20pt;
        }

        .caption {
            float: left;
            overflow: hidden;
            display: inline-block;
            text-align: left;
        }

        .toolbar {
            float: right;
            overflow: hidden;
            display: inline-block;
            text-align: right;
            font-size: 70%;
        }

        .summaryLeft {
            font-size: 70%;
            text-align: left;
        }

        .summaryRight {
            font-size: 70%;
            text-align: right;
        }

        .orbit {}

        .plot_frame {
            width: 100%;
            height: 80%;
            resize: both;
            overflow: auto;
        }

        .difference {
            color: red;
        }

        .small {
            font: italic 40% sans-serif;
        }

        th {
            vertical-align: bottom;
        }

        .chain-details-legend {
            text-align: center;
            font-style: italic;
        }

        .grid-controls-container {
            width: 100%;
            text-align: right;
            font-size: 90%;
        }

        .grid-controls {
            display: inline;
        }
        .control {
            display: inline;
        }

        .resizable {
            resize: both;
            overflow: auto;
        }

        .legend {
            text-align: center;
            font-style: italic;
        }

        .selected { background: Pink; }

        th { padding-left: 2pt; padding-right: 2pt; }

        .sort-asc::after { content: " \2193"; font-face: bold; }
        .sort-desc::after { content: " \2191"; font-face: bold;  }

        td.orbit { vertical-align: middle; }

        td.sum-total { text-align: center; }
        span.sum-total { border-top: 1px solid;}

        td.product-total { text-align: center; }
        span.product-total { border-top: 2px dotted red;}

        .chain-details { width: 100%; font-size: 80%; border-top: solid 1px black }
        .chain-details tr { vertical-align: top; }
        .chain-details tr:nth-child(even) { background: Ivory; }
        .chain-details tr:nth-child(odd) { background: WhiteSmoke; }

        .pagebreak {
            min-height: 1px;
            page-break-before: always;
        }

        .equation {
            background: WhiteSmoke;
            font-weight: bold;
        }
        .monomial { background: Ivory; }

        .equation-list { list-style-type: none; }
        .equation-list li { padding: 6pt; }

        input[type=number] {
            width: 40pt;
            text-align: right;
        }
        input.colourField {
            font-size: 80%;
            width: 30pt;
        }


        input[type=checkbox] {
            font-style: italic;
        }
        input[type=range] {
            width: 100%;
        }

    </style>


    <script type="text/javascript" src="js/toggles.js"></script>

    <script type="text/javascript" src="js/midi.js"></script>
    <script type="text/javascript" src="js/data.js"></script>



    <script type="text/javascript" src="js/bases.js"></script>
    <script type="text/javascript" src="js/orbits.js"></script>
    <script type="text/javascript" src="js/jbnd.js"></script>


    <script type="text/javascript" src="js/factors.js"></script>
    <script type="text/javascript" src="js/colors.js"></script>
    <script type="text/javascript" src="js/table.js"></script>

    <script type="text/javascript" src="js/x3dom-full.js"></script>
    <link rel="stylesheet" type="text/html" href="js/x3dom.css"/>

    <script type="text/javascript" src="js/3d.js"></script>


    <script>


        function getParam( defaultValues ) {

            var bases = defaultValues.bases;
            const toggles = defaultValues.toggles;

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            const basesParam = urlParams.get('bases');
            if ( basesParam ) {
                bases = basesParam
                    .split(',')
                    .map( x => Number( x ) );
            }

            const toggleParam = urlParams.get('toggles');
            if ( toggleParam ) {
                Object
                    .keys( toggles )
                    .forEach( k => toggles[k] = 0 );
                toggleParam
                    .split(',')
                    .forEach( x => toggles[x] = 1 );
            }

            return {
                id: urlParams.get('id'),
                bases: bases,
                orbits: urlParams.get('orbits'),
                toggles: toggles
            };
        }

        function getControlValues() {
            const planeIndex = Number( document.getElementById( 'planeIndex' ).value );
            const baseCount = Number( document.getElementById( 'bases' ).value );
            const emptyBases = new Array( baseCount ).fill( 0 );
            const bases = emptyBases.map( (x,i) => {
                try {
                    return Number( document.getElementById( `b${i}` ).value );
                } catch ( e ) {
                    return 1;
                }
            } );

            const currentToggles = Object
                    .keys( toggleKeys )
                    .filter( k => isToggle( k ) );

            return {
                planeIndex: planeIndex,
                bases: bases,
                toggles: currentToggles
            };
        }

        function getCurrentQueryString( basePlaneKey, bases ) {
            const values = getControlValues();

            if ( !bases ) {
                bases = values.bases;
            }

            return (basePlaneKey ? "id=" + basePlaneKey + "&" : "") + `bases=${ bases.join(',') }&toggles=${ values.toggles.join( ',' ) }`;
        }

        function reopenWithArgs() {
            window.location.href = "?" + getCurrentQueryString(  );
        }

        function reopenWithLeftRotatedArgs() {
            const bases = getControlValues().bases;
            bases.push(bases.shift());
            window.location.href = "?" + getCurrentQueryString( null, bases );
        }

        function reopenWithRightRotatedArgs() {
            const bases = getControlValues().bases;
            bases.reverse();
            bases.push(bases.shift());
            bases.reverse();
            window.location.href = "?" + getCurrentQueryString( null, bases );
        }


        function reopenWithReversedArgs() {
            const bases = getControlValues().bases;
            bases.reverse();
            window.location.href = "?" + getCurrentQueryString( null, bases );
        }


        function distributeMessage( containerId, message = {} ) {
            const plotFrame = document.getElementById( containerId + "_plot_frame" );
            plotFrame.contentWindow.postMessage( message, "*" );
            window.postMessage( message, "*" );
        }

        function distributeMessages( containerId, messages = [] ) {
            messages.forEach( message => distributeMessage( containerId, message) );
        }

        function showOrbit( containerId, basePlane, senderId, multi  ) {
            const tableCells = document
                .getElementById( containerId + "_table" )
                .querySelectorAll( "td.orbit" );

            const [ sourceId, ...oids ] = senderId.split( "." );

            tableCells.forEach( tableCell => {
                const [ cId, ...oId ] = tableCell.id.split( "." );
                if ( !arrayContains( oId, oids ) ) {
                    if ( !(multi && tableCell.classList.contains( "selected" ) ) ) {
                       tableCell.classList.remove("selected");
                    }
                } else if ( tableCell.classList.contains( "selected" ) ) {
                    tableCell.classList.remove("selected");
                } else {
                    tableCell.classList.add("selected");
                }
            } );

            document
                .getElementById( containerId + "_riffler" )
                .value = oids[0];
        }

        function showAllOrbits( containerId, basePlane ) {
            showOrbit( containerId, basePlane, "." );
        }

        function toggleSelected( item ) {
            if ( item.classList.contains('selected') ) {
                item.classList.remove('selected');
            } else {
                item.classList.add('selected');
            }
        }

        function clearSelected() {
            document
                .querySelectorAll( ".selected" )
                .forEach( item => item.classList.remove('selected') );
        }


        function initialiseCheckBox( controlId, checked ) {
            const control = document.getElementById( controlId );
            control.checked = checked;
        }


        function applyExpression( control, id, size, incrementPlaces = true ) {

            function maybeIncrementPlaces( control, id ) {
                if ( Number( control.value ) >= Number( control.max ) ) {
                    control.value = 0;
                    const nextId = (id+1) % size;
                    const nextPlace = document.getElementById( "o" + nextId );
                    nextPlace.value = Number( nextPlace.value ) + 1;
                    maybeIncrementPlaces( nextPlace, nextId );
                } else if ( Number( control.value ) < 0 ) {
                    control.value = Number( control.max ) - 1;
                    const nextId = (id+1) % size;
                    const nextPlace = document.getElementById( "o" + nextId );
                    nextPlace.value = Number( nextPlace.value ) - 1;
                    maybeIncrementPlaces( nextPlace, nextId );
                }
            }

            if ( incrementPlaces ) {
                maybeIncrementPlaces( control, id );
            }

            var locus = basePlane
                .orbits
                .map( (x, i) => Number( document.getElementById( "o" + i ).value ) );

            distributeMessage( 'sample_cs_b_10_m_2', { basePlaneKey: basePlane.key, locus: locus } );
        }


        function initialiseExpressor( basePlane, redraw = true ) {
            var expressor = document.getElementById( 'expressor' );
            while ( expressor.firstChild ) {
                expressor.removeChild( expressor.lastChild );
            }
            if ( redraw ) {
                expressor.appendChild( reify( "hr" ) );
                expressor.appendChild( reify(
                        "span",
                        {},
                        [],
                        [ s => s.innerHTML = "phase: " ]
                    )
                );
                basePlane.orbits.forEach( (orbit, i) => {
                    expressor.appendChild(
                        reify(
                            "input",
                            { "type": "number", "class": "colourField", "min": -1, "max": orbit.order, "id": ("o" + i), "value":0 },
                            [],
                            [ ( control ) => control.onchange = () => applyExpression( control, i, basePlane.orbits.length ) ]
                        )
                    );
                } );
            }
        }

        function initialiseBases( bases ) {
            document.getElementById( "bases" ).value = bases.length;
            const container = document.getElementById( "baseValues" );
            while (container.firstChild ) {
                container.removeChild( container.lastChild );
            }

            bases.forEach( (x,i) => {
                container
                    .appendChild(
                        reify(
                            "input",
                            { "id": "b" + i, "type": "number", "min": 1 },
                            [],
                            [
                                (control) => control.value = x,
                                (control) => control.onchange = updatePage
                            ] ) );
            } );
        }

        function initialiseControls( param ) {

            initialiseBases( param.bases );

            Object
                .entries(param.toggles)
                .forEach( ([key, value]) => {
                    initialiseCheckBox( `${ key }Toggle`, Boolean( value ) );
                } );

            function setNumberField( id, value ) {
                document.getElementById( id ).value = value;
            }
            const colourFields = [ "colour-red", "colour-green", "colour-blue", "colour-orbitIndex", "colour-minPixel" ];

            setNumberField( "colour-red", colourPointIndexDefault.bases[0] );
            setNumberField( "colour-green", colourPointIndexDefault.bases[1] );
            setNumberField( "colour-blue", colourPointIndexDefault.bases[2] );
            setNumberField( "colour-orbitIndex", colourPointIndexDefault.orbitIndex );
            setNumberField( "colour-minPixel", colourPointIndexDefault.minPixel );
            setNumberField( "colour-maxPixel", colourPointIndexDefault.maxPixel );

        }

        function openPlot() {
            const basePlane = getBasePlane( basePlaneKey );
            openX3DomFrame( 'sample_cs_b_10_m_2', basePlane );
        }

        function setMidiRepeats( orbitId, repeats ) {
            var orbit = basePlane.orbits.filter( x => x.index == orbitId );
            if ( orbit ) {
                orbit[0].midi.repeats = repeats;

                updateJson();
            }
        }

        function setMidiChannel( orbitId, channel ) {
            var orbit = basePlane.orbits.filter( x => x.index == orbitId );
            if ( orbit ) {
                orbit[0].midi.instrument = isPercussion ? 0 : instrument;
                if ( orbit[0].midi.percussion == 0 ) {
                    orbit[0].midi.channel = channel;
                }

                updateJson();
            }
        }

        function setMidiInstrument( orbitId, instrument, isPercussion = false ) {
            var orbit = basePlane.orbits.filter( x => x.index == orbitId );
            if ( orbit ) {
                orbit[0].midi.instrument = isPercussion ? 0 : instrument;
                orbit[0].midi.percussion = isPercussion ? instrument : 0;

                if ( isPercussion ) {
                    orbit[0].midi.channel = 9;
                } else if ( orbit[0].midi.channel == 9 ){
                    orbit[0].midi.channel = 0;
                }

                updateJson();
            }
        }


        function isToggle( toggle ) {
            const toggleControl = document.getElementById( toggle + "Toggle" );
            if ( !toggleControl ) {
                console.log( `No such toggle control: ${ toggle }Toggle` );
            }
            return toggleControl.checked;
        }


        function updateJson() {
            document
                    .getElementById("orbit-system-data-text-area")
                    .innerHTML = JSON.stringify( basePlane.getData(), null, 2 );

            var cellClick = "distributeMessages( 'sample_cs_b_10_m_2', [ { 'basePlaneKey': basePlane.key, 'multi': isToggle('multi'), 'sender': this.id } ] )";
            var clearClick = "distributeMessages( 'sample_cs_b_10_m_2', [ { 'basePlaneKey': basePlane.key, 'multi': false, 'sender': this.id } ] )";
            var totalClick = "distributeMessages( 'sample_cs_b_10_m_2', [ { 'basePlaneKey': basePlane.key } ] )";

            const tableArgs = {
                containerId: "sample_cs_b_10_m_2",
                basePlane: basePlane,
                cellClick: cellClick,
                clearClick: clearClick,
                totalClick: totalClick,
                midi: isToggle('midi'),
                conj: isToggle('conj'),
                jumps: isToggle('jumps'),
                radiants: isToggle('radiants'),
                perms: !isToggle('coords'),
            };

            drawBasePlaneTable( tableArgs );
        }


        function updatePage() {

            const param = getControlValues();

            // TODO: global access
            const box = new IndexedBox( param.bases );
            basePlane = box.indexPlanes[ param.planeIndex % box.indexPlanes.length ];
            putBasePlane( basePlane.key, basePlane );

            initialiseExpressor( basePlane, isToggle( 'locus' ) );

            document
                .getElementById( "sample_cs_b_10_m_2_riffler" )
                .setAttribute( "max", `${ basePlane.orbits.length - 1 }` );

            document
                    .getElementById("captionTex")
                    .innerHTML = basePlane.getCaptionHtml();

            document
                    .getElementById( "summary" )
                    .innerHTML = `<pre>${ box.getDataHtml() }</pre>`;

            document
                    .getElementById( "basesVolume" )
                    .value = basePlane.box.volume;

            document
                    .getElementById( "planeIndex" )
                    .max = box.indexPlanes.length - 1;


            updateJson();

            insertX3DomFrame(
                'sample_cs_b_10_m_2',
                basePlane,
                framePage = "orbitsViewer.html?" + getCurrentQueryString( basePlane.key ) );
        }

        function initPage( urlParam = true ) {

            const cv = getControlValues();

            if ( urlParam ) {
                cv.toggles = {...toggleKeys};
            }

            const param = urlParam
                ? getParam( cv )
                : cv;

            initialiseControls( param );


            const [ bases, orbitIndex, minPixel ] = getColorConfiguration();
            putBasePlane( "COLOR_ORBITS", new ColorBasePlane( bases, orbitIndex, minPixel ) );

            updatePage();

            if ( !urlParam ) {
                return;
            }

            if ( param.toggles.summary ) {
                showHideAll( [ 'selectedPoint', 'summary' ] );
            }
            if ( param.toggles.table ) {
                showHide( 'sample_cs_b_10_m_2_table' );
            }
            if ( param.toggles.more ) {
                showHideAll( ['more-options'] );
            }
            if ( param.toggles.colours ) {
                showHideAll( ['colours'] );
            }
            if ( param.toggles.midi ) {
                showHideCSS( '.midi' );
            }

            window.addEventListener( "message", ( event ) => {
                if ( event.data ) {
                    var data = event.data;

                    //console.log( `data: ${ JSON.stringify( data ) }` );

                    if ( data.basis ) {
                        if ( "point" == data.basis ) {
                            const selectedPoint = document.getElementById( "selectedPoint" );
                            selectedPoint.innerHTML = "<pre>" + data.report + "</pre>";
                        }

                    } else if ( data.basePlaneKey ) {
                        const basePlane = getBasePlane( data.basePlaneKey );
                        if ( event.data.sender ) {
                            showOrbit( "sample_cs_b_10_m_2", basePlane, data.sender, data.multi );
                        } else {
                            showAllOrbits( "sample_cs_b_10_m_2", basePlane );
                        }
                    } else if ( data.colors ) {

                        const [ bases, colorOrbitIndex, minPixel ] = data.colors;
                        putBasePlane( "COLOR_ORBITS", new ColorBasePlane( bases, colorOrbitIndex, minPixel ) );
                        updatePage();

                    } else if ( data.toggleCentres ) {
                    } else if ( data.toggleLines ) {
                    } else if ( data.clearSelected ) {
                        clearSelected();
                    }
                }
            });

            if ( param.id ) {
                distributeMessages( 'sample_cs_b_10_m_2', [ { 'basePlaneKey': basePlane.key, 'multi': isToggle('multi'), 'sender': 'dummy.' + param.id } ] );
            }

            distributeMessage( 'sample_cs_b_10_m_2', {
                basis: "point",
                report: basePlane.identities[0].coords[0].report()
            } );

        }
    </script>
</head>
<body id="testContainer001" onload="initPage()">
    <div>
        <div id="caption" class="caption">
            <a onclick="reopenWithArgs()"  title="reopen with current values in url"><b>Bases: </b></a>

            <input type="number" min="1" id="bases" value="3" onchange="initPage( false )"/>
            <a onclick="reopenWithReversedArgs()" title="reopen with reversed base values in url">&#8597;</a>
            <a onclick="reopenWithLeftRotatedArgs()" title="reopen with left-rotated base values in url">&#8592;</a>
            <a onclick="reopenWithRightRotatedArgs()" title="reopen with right-rotated base values in url">&#8594;</a>

            <span id="baseValues">
                <input type="number" min="1" id="b0" value="7"/>
                <input type="number" min="1" id="b1" value="5"/>
                <input type="number" min="1" id="b2" value="3"/>
            </span> |

            <input type="number" id="basesVolume" disabled="disabled"/> |

            index: <input type="number" min="0" id="planeIndex" value="0" onchange="updatePage()"/> |

            <span id="captionTex"></span>
            <br/>
        </div>


        <div id="toolbar" class="toolbar">
            <label title="display a summary of box properties">summary <input type="checkbox" id="summaryToggle" onchange="showHideAll(['selectedPoint','summary'], this )"/></label> |
            <label title="display a table of identities and orbits">table<input type="checkbox" id="tableToggle" onchange="showHide('sample_cs_b_10_m_2_table', this)" title="display a table of identities and orbits"/></label> |
            <label title="only if there are three bases, display a 3d projection">3d<input type="checkbox" id="grid3dToggle" onchange="updatePage()"/></label> |
            <label title="show each radiant instead of a chord diagram">radiants<input type="checkbox" id="radiantsToggle" onchange="updatePage()"/></label> |
            <label title="show more options">more<input type="checkbox" id="moreToggle" onchange="showHideAll( ['more-options'], this )"/></label>

            <div id="more-options" style="display: none">

                <hr/>
                <label title="show the box grid structure">grid<input type="checkbox" id="gridToggle" onchange="distributeMessage( 'sample_cs_b_10_m_2', { toggleGrid: 1 } )"/></label> |
                <label title="show orbit centres">centres<input type="checkbox" id="centresToggle" onchange="distributeMessage( 'sample_cs_b_10_m_2', { toggleCentres: 1 } )" /></label> |
                <label title="show the identity plane">plane<input type="checkbox" id="planeToggle" onchange="distributeMessage( 'sample_cs_b_10_m_2', { togglePlane: 1 } )"/></label> |
                <label title="show orbit lines">lines<input type="checkbox" id="linesToggle" onchange="distributeMessage( 'sample_cs_b_10_m_2', { toggleLines: 1 } )"/></label> |
                <label title="show the phase controls and the corresponding locus">locus<input type="checkbox" id="locusToggle" onchange="updatePage()"/></label> |
                <label title="scale 3d to a square">scale 3d<input type="checkbox" id="scale3dToggle" onchange="updatePage()"/></label>

                <hr/>
                <label title="rollup orbits with their conjugates">conj.<input type="checkbox" id="conjToggle" onchange="updatePage()"/></label> |
                <label title="show coordinates instead of ids">coords<input type="checkbox" id="coordsToggle" onchange="updatePage()"/></label> |
                <label title="show the jump patterns">jumps<input type="checkbox" id="jumpsToggle" onchange="updatePage()"/></label> |
                <label title="allow multi selection of orbits">multi<input type="checkbox" id="multiToggle"/></label>

                <hr/>
                <label title="colours">colours<input type="checkbox" id="coloursToggle" onchange="showHideAll( ['colours'], this )"/></label> |
                <label title="random">random<input type="checkbox" id="randomToggle" onchange="updatePage()"/></label> |
                <label title="midi">midi<input type="checkbox" id="midiToggle" onchange="showHideCSS( '.midi' )"/></label> |
                <a href="javascript:playMidi( JSON.parse( basePlane.getJson() ) )" title="play midi">play</a>

                <div>
                    <div id="expressor"></div>
                </div>

                <div id="colours" style="display: none">
                    <hr/>
                    <script>
                        const vId = id => Number( document.getElementById(id).value );
                        function getColorConfiguration() {
                            return [ [ vId("colour-red"), vId("colour-green"), vId("colour-blue") ], vId("colour-orbitIndex"), vId("colour-minPixel"), vId("colour-maxPixel") ];
                        }
                        function applyColorBasePlane() {
                            const [ bases, orbitIndex, minPixel, maxPixel ] = getColorConfiguration();
                            distributeMessage( "sample_cs_b_10_m_2", { colors: [ bases, orbitIndex, minPixel, maxPixel ] } );
                        }
                        function masterColorBasePlane() {
                            const [ bases, orbitIndex, minPixel, maxPixel ] = getColorConfiguration();
                            initialiseBases( bases );
                            updatePage();
                            distributeMessages( 'sample_cs_b_10_m_2', [ { 'basePlaneKey': basePlane.key, 'multi': isToggle('multi'), 'sender': 'colourBasePlane.' + orbitIndex } ] );
                        }
                    </script>
                    rgb
                    <input type="number" min="1" id="colour-red" value="4" class="colourField"/>
                    <input type="number" min="1" id="colour-green" value="4" class="colourField"/>
                    <input type="number" min="1" id="colour-blue" value="6" class="colourField"/> |
                    index <input type="number" min="1" id="colour-orbitIndex" value="1" class="colourField"/> |
                    <a href="javascript:masterColorBasePlane()">master</a> |
                    min-pixel <input type="number" min="0" max="255" id="colour-minPixel" value="50" class="colourField"/> |
                    max-pixel <input type="number" min="0" max="255" id="colour-maxPixel" value="200" class="colourField"/> |
                    <a href="javascript:applyColorBasePlane()">apply</a>
                </div>



            </div>
            <div style="display: none" class="midi">
                <hr/>
                <textarea id="orbit-system-data-text-area" style="width: 100%; height: 40%;"></textarea>
            </div>
        </div>
    </div>

    <div>
        <table width="100%">
            <tr>
                <td class="summaryLeft"><span id="selectedPoint" style="display: none"></span></td>
                <td class="summaryRight"><span id="summary" style="display: none"></span></td>
            </tr>
        </table>
    </div>

    <div id="sample_cs_b_10_m_2_table" style="display: none"></div>


    <div id="sample_cs_b_10_m_2_plot"></div>

    <div class='legend'>
        [ a, r, u | e, f, l, w, &lt;space&gt; ]
        see: <a href="https://doc.x3dom.org/tutorials/animationInteraction/navigation/index.html" target="_new">x3dom navigation tutorial</a>

    </div>
    <div style="width: 100%">
        <input
                type="range"
                min="0"
                max="1"
                id="sample_cs_b_10_m_2_riffler"
                oninput="distributeMessages( 'sample_cs_b_10_m_2', [ { 'basePlaneKey': basePlane.key, 'multi': false, 'sender': ( this.id + '.' + this.value ) } ] )"/>
    </div>

</body>
</html>
