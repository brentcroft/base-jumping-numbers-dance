<html>
    <head>
        <meta charset="utf-8"/>
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
                font-size: 80%;
            }
            .legend {
                text-align: center;
                font-style: italic;
            }
            .plot-container {
              border: 10px inset #f0f0f0;
              width: 100%;
              height: 100%;
              resize: both;
              overflow: auto;
            }
        </style>

<!--        <script src="https://d3js.org/d3.v7.min.js"></script>-->
<!--        <script type="text/javascript" src="d3.layout.force3d.js"></script>-->

        <script type="text/javascript" src="js/x3dom-full.js"></script>
        <link rel="stylesheet" type="text/html" href="js/x3dom.css"/>

        <script type="text/javascript" src="js/data.js"></script>
        <script type="text/javascript" src="js/orbits.js"></script>
        <script type="text/javascript" src="js/3d.js"></script>

        <script>
            function getParam() {

                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);

                const basesParam = urlParams.get('bases');

                const toggles = {
                    table: 0,
                    grid: 0,
                    centres: 0,
                    lines: 0
                };

                const toggleParam = urlParams.get('toggles');
                if ( toggleParam ) {
                    toggleParam
                        .split(',')
                        .forEach( x => toggles[x] = 1 );
                }

                return {
                    id: urlParams.get('id'),
                    bases: basesParam.split(",").map(x=> Number(x)),
                    orbits: urlParams.get('orbits'),
                    toggles: toggles
                };
            }

            function clearSelected() {
                document
                    .querySelectorAll( ".selected" )
                    .forEach( item => item.classList.remove('selected') );
            }
            function toggleLines( containerId ) {
                toggleBySelector( containerId, ".orbit"  );
            }
            function toggleLocus( containerId ) {
                toggleBySelector( containerId, ".orbit-system-locus"  );
            }
            function toggleGrid( containerId ) {
                toggleBySelector( containerId, ".grid-coords" );
            }
            function toggleCentres( containerId ) {
                toggleBySelector( containerId, ".orbit-centre" );
            }
            function togglePlane( containerId ) {
                toggleBySelector( containerId, ".orbit-plane" );
            }


            function toggleBySelector( containerId, cssSelector, translator = (x) => x ) {
                const selectedElements = document
                    .getElementById( containerId )
                    .querySelectorAll( cssSelector );

                selectedElements.forEach( selectedElement => {
                        const element = ( translator )
                            ? translator( selectedElement )
                            : selectedElement;
                        const render = ("false" == element.getAttribute( "render" ) );
                        element.setAttribute( "render", render );
                    });
            }


            function showLocus( containerId, orbitSystem, locusPoints, multi ) {
                const locusGroup = document
                    .getElementById( containerId )
                    .querySelector( "group.orbit-system-locus" );

                while ( locusGroup.firstChild ) {
                    locusGroup.removeChild( locusGroup.lastChild );
                }

                locusGroup.appendChild( createLineSet( orbitSystem.getLocusPoints( locusPoints ) ) );
            }


            function showOrbit( containerId, orbitSystem, senderId, multi ) {
                const [ tableId, ...orbitIds ] = senderId.split( "." );
                const orbits = document
                    .getElementById( containerId )
                    .querySelectorAll( ".orbit" );

                orbits.forEach( orbitElement => {
                        const [ cId, oId ] = orbitElement.id.split( "." );
                        if ( !orbitIds.includes( oId ) ) {
                            if ( multi && orbitElement.classList.contains( "selected" ) ) {
                            } else {
                                orbitElement.setAttribute( "render", false );
                                orbitElement.classList.remove("selected");
                            }
                        } else if ( orbitElement.classList.contains( "selected" ) ) {
                            orbitElement.setAttribute( "render", false );
                            orbitElement.classList.remove("selected");
                        } else {
                            orbitElement.setAttribute( "render", true );
                            orbitElement.classList.add("selected");
                        }
                    });
            }

            function showAllOrbits( containerId, orbitSystem ) {
                const orbits = document
                    .getElementById( containerId )
                    .querySelectorAll( ".orbit" )
                    .forEach( orbitElement => {
                        orbitElement.setAttribute( "render", true );
                        orbitElement.classList.remove("selected");
                    });
            }


            function getOrbitSystemItems( orbitSystem, toggles ) {

                const orbits = orbitSystem.orbits;
                const fixedPointTransparency = 0.2;
                const colorOrbitSystem = window.parent.window.getOrbitSystem( "COLOR_ORBITS" );

                const [ p1, p2 ] = orbitSystem.box.diagonal;
                const scaleUnit = toggles.scale ? unitDisplacement( p1, p2 ) : [ 1, 1, 1 ];

                // move origin to system centre and scale by scaleUnit
                const root = reify(
                    "transform", {
                        "translation": orbitSystem.box.bases.map( b => -b/2 ).join( ' ' ),
                        "scale": scaleUnit.map( x => x==0?1:1/x ).join( ' ' )
                    } );

                function appendGridChildren( grid ) {
                    const [ b0, b1, b2 ] = orbitSystem.box.bases;
                    const gridCoordStyle = { "family": "'San Serif'", "size": 0.05 };
                    const gridPointRadius = 0.05;

                    for ( var i = 0; i < b0; i++ ) {
                        for ( var j = 0; j < b1; j++ ) {
                            for ( var k = 0; k < b2; k++ ) {
                                grid
                                    .appendChild(
                                        reify(
                                            "Transform",
                                            {
                                                "translation": [ i, j, k ].join( ' ' ),
                                                "scale": scaleUnit.join( ' ' )
                                            },
                                            [
                                                createSphereShape( gridPointRadius, 'black' ),
                                                createTextShape( `(${ [ i, j, k ].join( ',' ) })`, gridCoordStyle )
                                            ]
                                        )
                                    );
                            }
                        }
                    }
                }

                // GRID
                root
                    .appendChild(
                        reify(
                            "Collision",
                            {
                                "class": "grid-coords",
                                "enabled": false,
                                "render": Boolean( toggles.grid )
                            },
                            [],
                            [ appendGridChildren ]
                        )
                    );




                // CENTRE LINES
                const centrePoints = orbitSystem
                    .centrePoints
                    .map( x => reify(
                                    "transform",
                                    {
                                        "translation": x.point.join( ' ' ),
                                        "scale": scaleUnit.join( ' ' )
                                    },
                                    [ createSphereShape( 0.1, "yellow", fixedPointTransparency ) ]
                                ) );

                const centreLines = orbitSystem
                    .centreLines
                    .map( centreLine => createLineSetFromPoints( centreLine.points, "gray", "3" ) );

                root
                    .appendChild(
                        reify(
                            "group",
                            { "class": "orbit-centre", "render": Boolean( toggles.centres ) },
                            centrePoints.concat( centreLines )
                        )
                    );

                // FIXED POINTS
                orbitSystem
                    .identityPoints
                    .map( point => {
                        return {
                            "translation": point.coords[0].coord.join( ' ' ),
                            "scale": scaleUnit.join( ' ' )
                        };
                    })
                    .forEach( identityPoint => root
                        .appendChild(
                            reify(
                                "Transform",
                                identityPoint,
                                [ createSphereShape( 0.1, "red", fixedPointTransparency ) ] )
                            )
                        );


                // ORBITS
                for ( var i = 0; i < orbits.length; i++ ) {
                    const orbit = orbits[i];
                    const orbitColor = colorOrbitSystem.colorForIndex( orbit.index );
                    root
                        .appendChild(
                            reify(
                                "group",
                                { "class": "orbit", "id": ("orbit." + orbit.index ) },
                                [
                                    createLineSet( orbit.coords, orbitColor ),
                                    reify(
                                        "transform",
                                        {
                                            "translation": orbit.centre.join( ' ' ),
                                            "scale": scaleUnit.join( ' ' )
                                        },
                                        [ createSphereShape( 0.09, "gray" ) ]
                                    ),
                                    ...orbit.coords.map( (x,i) => reify(
                                        "transform",
                                        {
                                            "translation": x.coord.join( ' ' ),
                                            "scale": scaleUnit.join( ' ' ),
                                            "class": "orbitCoord",
                                            "id": `orbitCoord.${ x.index }.${ i }`
                                        },
                                        [ createSphereShape( 0.05, orbitColor ) ] ) )
                                ],
                                [ ( e ) => e.setAttribute( "render", Boolean( toggles.lines ) ) ]
                            )
                        );
                }

                // PLANE
                var currentDirection = [0,1,0];
                var box = orbitSystem.box;
                var planeColor = "gray";
                var planeTransparency = 0.95;

                var planeItem = createPlaneItem(
                        box.centre,
                        box.unitNormal,
                        scaleUnit,
                        currentDirection,
                        box.origin,
                        [ box.bases[0], 0, box.bases[box.bases.length-1] ],
                        planeColor,
                        planeTransparency);

                planeItem.setAttribute( "render", Boolean( toggles.plane ) );

                root
                    .appendChild( planeItem );

                root
                    .appendChild(
                        reify(
                            "Group",
                            {
                                "class": "orbit-system-locus",
                                "render": Boolean( toggles.locus )
                            },
                            [
                                createLineSet( orbitSystem.getLocusPoints( orbitSystem.locusPoints ) )
                            ]
                        )
                    );

                return reify( "collision", { "enabled": false }, [ root ] );
            }


            function getOrbitSystemGears( orbitSystem, toggles ) {

                const orbits = orbitSystem.orbits;
                const fixedPointTransparency = 0.1;
                const colorOrbitSystem = window.parent.window.getOrbitSystem( "COLOR_ORBITS" );
                const root = reify( "Transform", { "translation": orbitSystem.box.bases.map( b => -b/2 ).join( ' ' ) } );

                // ORBITS
                for ( var i = 0; i < orbits.length; i++ ) {
                    const orbit = orbits[i];
                    if (orbit.coords.length > 1 ) {
                        root
                            .appendChild(
                                reify(
                                    "transform",
                                    { "translation": `${ i } 0 0`, "class": "orbit", "id": ("orbit." + orbit.index ) },
                                    [ createDialLineSet( orbit.coords, colorOrbitSystem.colorForIndex( orbit.index ) ) ]
                                )
                            );
                    }
                }
                return reify( "collision", { "enabled": false }, [ root ] );
            }

            function plotData( duration ) {
                const param = getParam();
                const orbitSystem = window.parent.window.getOrbitSystem( param.id );
            }


            function plotOrbitSystem( orbitSystem, param ) {

                var x3domContainerId =  'testContainer001_plot';
                const sceneRootId = `${ x3domContainerId }_scene_root`;
                const sceneRoot = document.getElementById( sceneRootId );

                var osi = (param.toggles.gears)
                    ? getOrbitSystemGears( orbitSystem, param.toggles )
                    : getOrbitSystemItems( orbitSystem, param.toggles );

                sceneRoot.appendChild( osi );

                var x3dRuntime = document.getElementById( x3domContainerId );
                x3dRuntime.runtime.resetView();
                //console.log( "Created X3DOM container: " + x3domContainerId );
            }

            function initPage() {

                const param = getParam();
                const orbitSystem = window.parent.window.getOrbitSystem( param.id );

                plotOrbitSystem( orbitSystem, param );

                window.addEventListener( "message", ( event ) => {
                    if ( event.data ) {
                        var data = event.data;

                        //console.log( `data: ${ JSON.stringify( data ) }` );

                        if ( data.orbitSystemKey ) {
                            const orbitSystem = window.parent.window.getOrbitSystem( data.orbitSystemKey );
                            if ( data.sender ) {
                                showOrbit( "testContainer001", orbitSystem, data.sender, data.multi );
                            } else if ( data.locus ) {
                                showLocus( "testContainer001", orbitSystem, data.locus, data.multi );
                            } else {
                                showAllOrbits( "testContainer001", orbitSystem );
                            }
                        } else if ( data.toggleGrid ) {
                            toggleGrid( "testContainer001" );
                        } else if ( data.toggleCentres ) {
                            toggleCentres( "testContainer001" );
                        } else if ( data.togglePlane ) {
                            togglePlane( "testContainer001" );
                        } else if ( data.toggleLines ) {
                            toggleLines( "testContainer001" );
                        } else if ( data.toggleLocus ) {
                            toggleLocus( "testContainer001" );
                        } else if ( data.clearSelected ) {
                            clearSelected();
                        }
                    }
                });
            }
        </script>
    </head>
    <body id="testContainer001" onload="initPage()">
        <x3d id="testContainer001_plot" showStat="false" width="100%" height="100%">
<!--            <viewpoint centreOfRotation="0 0 0" position="0 0 50"></viewpoint>-->
            <scene id="testContainer001_plot_scene_root">
            </scene>
        </x3d>
    </body>
</html>
