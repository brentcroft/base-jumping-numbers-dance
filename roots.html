<html>
<head>
    <meta charset="utf-8"/>

    <script type="text/javascript" src="js/x3dom.js"></script>
    <link rel="stylesheet" type="text/html" href="js/x3dom.css"/>

    <link rel="stylesheet" href="css/orbits.css">

    <!-- model -->
    <script type="text/javascript" src="js/toggles.js"></script>
    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/orbits.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/group.js"></script>
    <script type="text/javascript" src="js/expression.js"></script>

    <script type="text/javascript" src="js/orbitation.js"></script>
    <script type="text/javascript" src="js/bitmap.js"></script>
    <script type="text/javascript" src="js/glyphs.js"></script>

    <script type="text/javascript" src="js/forces.js"></script>

    <!-- ui -->
    <script type="text/javascript" src="js/factors.js"></script>
    <script type="text/javascript" src="js/colors.js"></script>
    <script type="text/javascript" src="js/htmltable.js"></script>
    <script type="text/javascript" src="js/3d.js"></script>

    <!-- page -->
    <script type="text/javascript">
        var instance = 0;
        function sendResult( result, sourceElement, param = {} ) {
            if ( !result ) {
                return;
            }
            var tag = null;
            var items = 0;
            const excludes = param.excludes | [];

            function decomposeValue( label, value ) {
                return reify(
                    "div",
                    { class: 'summaryLeft' },
                    [],
                    [ d => d.innerHTML = `${ label ? label + ': ' : '' }${ value }` ]
                );
            }

            function decomposeObject( label, value ) {
                // do non-arrays first
                return reify( "div", {}, [
                    decomposeValue( null, label ),
                    ...Object
                        .entries( value )
                        .filter( ([k,v]) => !excludes.includes( k ) )
                        .filter( ([k,v]) => !Array.isArray( v ) )
                        .map( ([k,v]) => decomposeValue( k, v ) ),
                    ...Object
                        .entries( value )
                        .filter( ([k,v]) => !excludes.includes( k ) )
                        .filter( ([k,v]) => Array.isArray( v ) )
                        .map( ([k,v]) => decomposeArray( k, v ) )
                ] );
            }
            function decomposeArray( key, value ) {
                const firstElement = value[ 0 ];
                const isNested = Array.isArray( firstElement );
                return reify(
                    "textarea", { class: 'scriptPanelTextArea', rows: isNested ? Math.min( 20, 1 + value.length ) : 2, disabled: 'disabled' }, [], [
                        d => d.value = key + ":\n" +
                           ( isNested
                                ? value
                                    .map( r => r
                                        .map( a => String( a ).padStart( 2, ' ' ) )
                                        .join( ', ' ) )
                                    .join( '\n' )
                                : Number.isInteger( firstElement )
                                    ? value.join( ', ' )
                                    : value.join( '\n' ))
                    ] );
            }

            function decompose( result ) {
                const key = `<br/><hr/><b>result:</b> ${ new Date().toISOString() }<br/>`;
                return Array.isArray( result )
                    ? decomposeArray( key, result )
                    : result instanceof Object
                        ? decomposeObject( key, result )
                        : decomposeValue( null, result );
            }

            const css = ( param.css || [] );
            if ( !css.includes( 'rightFlow' ) ) {
                css.push( 'leftFlow' );
            }

            const cssClasses = [ 'scriptPanelResult', ...css ];

            var targetElement = reify(
                "div",
                { class: cssClasses.join( ',' ) },
                [ decompose( result ) ]
            );

            sourceElement.parentNode.appendChild( targetElement );
        }

        function pagebreak() {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );

            var targetElement = reify( "div", { class: 'pagebreak' }, [] );

            sourceElement.parentNode.appendChild( targetElement );
        }

        function putHtml( result, param ) {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );
            sendResult( result, sourceElement, param );
        }

        function calculate( script, sourceElement ) {
            if ( document.getElementById( 'clearOnCalculate' ).checked ) {
                clearResults();
            }
            try {
                const result = eval( script );
                putHtml( result );
            } catch ( e ) {
                putHtml( `<font color='red'>${ e }</font>` );
                throw e;
            }
        }

        function clearResults() {
            document
                .querySelectorAll( '.scriptPanelResult' )
                .forEach( element => element.parentNode.removeChild( element ) );
        }

        function calculateNow() {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );

            calculate( sourceElement.value, 'calculationResult' );
        }

        function glyphs( perm, maxBar, width, height ) {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );
            writeBarGlyphs( sourceElement, perm, maxBar, width, height + 25 );
        }

        function rootSummary( base, stride, param = {} ) {
            try {
                const clockfaces = getClockfaces(  base, stride );
                return [ stride, getOrbits( clockfaces )
                    .filter( o => o.length > 1 )
                    .map( o => `( ${ o.join( ' ' ) } )` )
                    .join('') ];
            } catch ( e ) {
                putHtml( param.stack
                    ? { base: base, stride: stride, '!': e.stack.replaceAll( '\n', '<br/>' ) }
                    : { base: base, stride: stride, '!': e } );
            }
        }

        function oneRoots( base, stride, w, h, param = {} ) {
            try {
                const r = rootsInfo( base, stride )
                putHtml( r, param );
                if ( param.glyphs ) {
                    r[ 'roots' ].forEach( x => glyphs( x, base, w, h ) );
                }
            } catch ( e ) {
                putHtml( param.stack
                    ? { base: base, stride: stride, '!': e.stack.replaceAll( '\n', '<br/>' ) }
                    : { base: base, stride: stride, '!': e } );
            }
        }

        function allRoots( base, w, h, param = {} ) {
            aoi( base )
                // drop strides 0, 1
               .splice( 2 )
               .forEach( stride => oneRoots( base, stride, w, h, param ) );
        }

        function putDomNode( node, param = {} ) {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );
            const { css = [] } = param;
            sourceElement
                .parentNode
                .appendChild( reify( "div", { "class": [ 'scriptPanelResult', ...css ].join( "," ) }, [ node ] ) );
        }


        function putX3DomNode( orb, param = {} ) {
            const { css = [] } = param;

            const x3dRoot = reify(
                "x3d",
                { "width": "100%", "height": "100%" },
                [
                    reify(
                        "scene",
                        { "id": "plot_scene_root" },
                        orb.points.map( p => p.shape )
                    )
                ]
            );

            orb.x3dRoot = x3dRoot;

            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );

            if ( !css.includes( 'rightFlow' ) ) {
                css.push( 'leftFlow' );
            }

            sourceElement
                .parentNode
                .appendChild( reify( "div", { "class": [ 'scriptPanelResult', ...css ].join( "," ) }, [ x3dRoot ] ) );

            x3dom.reload();




            const runButton = reify( "input", { "type": "button", "value": "run" } );
            runButtonAction = ( iteration ) => {
                if ( iteration == 0 ) {
                    runButton.value = 'forces';
                    param.running = false;
                } else {
                    runButton.value = iteration;
                };
            };
            runButton.onclick = () => {
                if ( param.running ) {
                    param.running = false;
                } else {
                    applyForces( orb, param, runButtonAction )
                }
            };

            const originFactorInput = reify( "div", {}, [ reify( "label", {},
            [
                reify( "span",{},[],[ c => c.innerHTML = "origin-factor " ] ),
                reify( "input", { type: "number", class: "decimal-input", step: 0.01, value: orb.param.originFactor },
                    [], [ c => c.onchange = () =>orb.param.pairFactor = c.value ] )
            ] ) ] );

            const pairFactorInput = reify( "div", {}, [ reify( "label", {},
            [
                reify( "span",{},[],[ c => c.innerHTML = "pair-factor " ] ),
                reify( "input", { type: "number", class: "decimal-input", step: 0.1, value: orb.param.pairFactor },
                    [], [ c => c.onchange = () =>orb.param.pairFactor = c.value ] )
            ] ) ] );



            const linkControlHeaders = [ "exponent", "spring-length", "spring-constant" ];
            const linkControlRows = orb.linkParam
                .map( ( expData, i ) => reify( "tr", {},
                    [
                        reify( "td", {}, [ reify( "label", {}, [], [ c => c.innerHTML = expData[ 0 ] ] ) ] ),
                        reify( "td", {}, [ reify( "label", {}, [
                            reify( "input", { type: "number", class: "decimal-input", step: 0.1, value: expData[ 1 ].toFixed( 4 ) },
                                [], [ c => c.onchange = () => orb.linkParam[ i ][ 1 ] = c.value ] ) ] ) ] ),
                        reify( "td", {}, [ reify( "label", {}, [
                            reify( "input", { type: "number", class: "decimal-input", step: 0.000001, value: expData[ 2 ].toFixed( 10 ) },
                                [], [ c => c.onchange = () => orb.linkParam[ i ][ 2 ] = c.value ] ) ] ) ] )
                    ],
                    [
                        tr => tr.style.backgroundColor = expData[ 3 ]
                    ]
                ) );

            const linkControls = reify( "div", { id: "link_controls" },
                [
                    reify( "table", {},
                        [
                            reify( "tr", {}, linkControlHeaders.map( h => reify( "th", {}, [], [ c => c.innerHTML = h ] ) ) ),
                            ...linkControlRows
                        ]
                    )
                ],
                [
                    c => c.style.display = 'none'
                ]);

            sourceElement
                .parentNode
                .appendChild( reify( "div", { "class": [ 'scriptPanelResult', 'rightFlow' ].join( "," ) }, [
                    runButton,
                    originFactorInput,
                    pairFactorInput,
                    reify( "label", {}, [
                        reify( "text", {}, [], [ t => t.textContent = "show/hide link controls" ] ),
                        reify( "input", { type: "checkbox" }, [], [ input => input.onclick = () => showHide( "link_controls", input ) ] )
                    ] ),
                    linkControls
                ] ) );



            orb.points.forEach( p => {
                new x3dom.Moveable(
                    x3dRoot,
                    p.shape,
                    ( shape, position ) => {
                         p.coord = [ position.x, position.y, position.z ];
                         p.moveLinks();
                    },
                    0 );
            } );

            applyForces( orb, param, runButtonAction );
        }
    </script>
    <style>
        .scriptPanel {
            width: 100%;
        }
        .scriptPanelResult {
            margin: 10px;
        }
        .scriptPanelTextArea {
            width: 100%;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
        }
        .symbol-details { font-size: 80%; border-top: solid 1px black; border-bottom: solid 1px black }
        .symbol-details tr { vertical-align: top; }
        .symbol-details tr:nth-child(even) { background: Ivory; }
        .symbol-details tr:nth-child(odd) { background: WhiteSmoke; }
        .symbol-details tr > td { border-top: 1px black dotted; }

        .resizable {
            overflow-wrap: normal;
            overflow-x: scroll;
        }
        .leftFlow {
           float: left;
        }
        .rightFlow {
           float: right;
        }

        div input[ type=number ].decimal-input {
            width: 150px;
        }
        td input[ type=number ].decimal-input {
            width: 100%;
        }

        tr.selected td {
            background: pink;
        }

    </style>

</head>
<body onload="calculateNow()">
    <input type="button" value="eval" onclick="calculateNow()"/>
    <input type="button" value="clear" onclick="clearResults()"/>
    <label class="summaryLeft">clear on calculate<input type="checkbox" checked="checked" id="clearOnCalculate"/></label>
    <br/>
    <textarea id="calculationScript" class="scriptPanel" rows="1">const param = {
    forces: [ 'xorigin', 'pair', 'link' ],
    originFactor: 0.01,
    pairFactor: -3,
    rodLengthExp: 1,
    rodStrengthExp: 2,
    newtonian: true,
    friction: 0.96,
    minDist: 0.000000000001,
    minDelta: 0.000000000001,
    maxDelta: 10,
    burst: 100,
};
examples = [ [ 2, 2, 3 ], [ 3, 3, 5 ] ];
const orb = new Orbitation( [ 40 ], param );
putX3DomNode( orb, { css: [ 'resizable', 'leftFlow' ], iterations: 2000, tickTime: 10, ...param } );
putDomNode( orb.htmlTable(), { css: [ 'rightFlow' ] } );
putHtml( orb.fragmentsBlock() );
</textarea>
</body>
</html>