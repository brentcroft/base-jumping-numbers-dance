<html>
<head>
    <meta charset="utf-8"/>

    <script type="text/javascript" src="js/x3dom.js"></script>
    <link rel="stylesheet" type="text/html" href="js/x3dom.css"/>

    <link rel="stylesheet" href="css/orbits.css">

    <!-- model -->
    <script type="text/javascript" src="js/toggles.js"></script>
    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/orbits.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript" src="js/group.js"></script>
    <script type="text/javascript" src="js/expression.js"></script>

    <script type="text/javascript" src="js/orbitation.js"></script>
    <script type="text/javascript" src="js/bitmap.js"></script>
    <script type="text/javascript" src="js/glyphs.js"></script>


    <!-- ui -->
    <script type="text/javascript" src="js/factors.js"></script>
    <script type="text/javascript" src="js/colors.js"></script>
    <script type="text/javascript" src="js/table.js"></script>
    <script type="text/javascript" src="js/3d.js"></script>

    <!-- page -->
    <script type="text/javascript">
        var instance = 0;
        function sendResult( result, sourceElement, excludes = [] ) {
            if ( !result ) {
                return;
            }
            var tag = null;
            var items = 0;

            function decomposeValue( label, value ) {
                return reify(
                    "div",
                    { class: 'summaryLeft' },
                    [],
                    [ d => d.innerHTML = `${ label ? label + ': ' : '' }${ value }` ]
                );
            }

            function decomposeObject( label, value ) {
                // do non-arrays first
                return reify( "div", {}, [
                    decomposeValue( null, label ),
                    ...Object
                        .entries( value )
                        .filter( ([k,v]) => !excludes.includes( k ) )
                        .filter( ([k,v]) => !Array.isArray( v ) )
                        .map( ([k,v]) => decomposeValue( k, v ) ),
                    ...Object
                        .entries( value )
                        .filter( ([k,v]) => !excludes.includes( k ) )
                        .filter( ([k,v]) => Array.isArray( v ) )
                        .map( ([k,v]) => decomposeArray( k, v ) )
                ] );
            }
            function decomposeArray( key, value ) {
                const firstElement = value[ 0 ];
                const isNested = Array.isArray( firstElement );
                return reify(
                    "textarea", { class: 'scriptPanelTextArea', rows: isNested ? Math.min( 20, 1 + value.length ) : 2, disabled: 'disabled' }, [], [
                        d => d.value = key + ":\n" +
                           ( isNested
                                ? value
                                    .map( r => r
                                        .map( a => String( a ).padStart( 2, ' ' ) )
                                        .join( ', ' ) )
                                    .join( '\n' )
                                : value
                                    .join( ', ' ) )
                    ] );
            }

            function decompose( result ) {
                const key = `<br/><hr/><b>result:</b> ${ new Date().toISOString() }<br/>`;
                return Array.isArray( result )
                    ? decomposeArray( key, result )
                    : result instanceof Object
                        ? decomposeObject( key, result )
                        : decomposeValue( null, result );
            }

            var targetElement = reify(
                "div",
                { class: 'scriptPanelResult' },
                [ decompose( result ) ]
            );

            sourceElement.parentNode.appendChild( targetElement );
        }

        function show( result, excludes ) {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );
            sendResult( result, sourceElement, excludes );
        }

        function calculate( script, sourceElement ) {
            if ( document.getElementById( 'clearOnCalculate' ).checked ) {
                clearResults();
            }
            try {
                show( eval( script ) );
            } catch ( e ) {
                show( `<font color='red'>${ e }</font>` );
            }
        }

        function clearResults() {
            document
                .querySelectorAll( '.scriptPanelResult' )
                .forEach( element => element.parentNode.removeChild( element ) );
        }
        function calculateNow() {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );

            calculate( sourceElement.value, 'calculationResult' );
        }

        function glyphs( perm, maxBar, width, height ) {
            const sourceId = 'calculationScript';
            const sourceElement = document.getElementById( sourceId );
            writeBarGlyphs( sourceElement, perm, maxBar, width, height + 25 );
        }

        function oneRoots( base, stride, w, h, param = {} ) {
            try {
                const r = rootsInfo( base, stride )
                show( r, param.excludes );
                r[ 'roots' ].forEach( x => glyphs( x, base, w, h ) );
            } catch ( e ) {
                show( param.stack
                    ? { base: base, stride: stride, '!': e.stack.replaceAll( '\n', '<br/>' ) }
                    : { base: base, stride: stride, '!': e } );
            }
        }

        function allRoots( base, w, h, param = {} ) {
            aoi( base )
                // drop strides 0, 1
               .splice( 2 )
               .forEach( stride => oneRoots( base, stride, w, h, param ) );
        }


    </script>

    <style>
        .scriptPanel {
            width: 100%;
        }
        .scriptPanelResult {
        }
        .scriptPanelTextArea {
            width: 100%;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: scroll;
        }
    </style>

</head>
<body onload="calculateNow()">
    <input type="button" value="eval" onclick="calculateNow()"/>
    <input type="button" value="clear" onclick="clearResults()"/>
    <label class="summaryLeft">clear on calculate<input type="checkbox" checked="checked" id="clearOnCalculate"/></label>
    <br/>
    <textarea id="calculationScript" class="scriptPanel" rows="10">
const width = 10;
const param = { excludes: [ 'roots' ], stack: 0 };
const bases = [ 5, 3 ];
const volume = bases.reduce( ( a, c ) => a * c, 1 );
const terminal = volume - 1;

//allRoots( bases[0], width, bases[0] + 1, param );
//allRoots( bases[1], width, bases[1] + 1, param );
//oneRoots( terminal, bases[0], width, bases[0] + 1, param );
allRoots( terminal, width, volume, param );
</textarea>
</body>
</html>